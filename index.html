<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Bus Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --background-color: #f0f4f8;
            --text-color: #1e293b;
            --card-background: #ffffff;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            overflow: hidden; 
        }

        #app-container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        
        #app-container.lite-mode-on #map-area {
            display: none;
        }
        #app-container.lite-mode-on #sidebar {
            width: 100%;
            height: 100%;
            box-shadow: none;
            border-top: none;
        }

        
        header {
            background-color: var(--card-background);
            padding: 12px 16px;
            box-shadow: var(--shadow);
            z-index: 1001;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
        }

        header h1 i {
            color: var(--primary-color);
            margin-right: 10px;
        }

        
        .lite-mode-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .lite-mode-toggle label {
            margin-right: 8px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        
        #main-content {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
        }

        
        #sidebar {
            width: 320px;
            background-color: var(--card-background);
            padding: 16px;
            overflow-y: auto;
            box-shadow: var(--shadow);
            z-index: 1000;
            transition: width 0.3s ease;
        }

        #route-selector, #bus-info {
            margin-bottom: 20px;
        }

        #route-selector label, #bus-info h3 {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 8px;
            display: block;
        }
        
        #route-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        #bus-info-content {
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.875rem;
            display: none; 
        }
        
        #bus-info-content p {
            margin: 0 0 8px 0;
        }

        #bus-info-content p:last-child {
            margin-bottom: 0;
        }

        #eta-list h3 {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        #stops-container {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        #stops-container li {
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
        }

        #stops-container li:last-child {
            border-bottom: none;
        }

        .stop-icon {
            color: var(--primary-color);
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }
        
        .stop-details {
            flex-grow: 1;
        }

        .stop-details .stop-name {
            font-weight: 500;
        }

        .eta {
            font-weight: 600;
            color: #16a34a; 
        }
        
        .eta.arrived {
            color: #64748b;
            font-weight: 500;
        }
        
        #map-area {
            flex-grow: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .bus-icon {
            text-align: center;
            font-size: 1.8rem;
            color: var(--primary-color);
            text-shadow: 0 0 3px #fff;
        }
        
        .bus-icon-lite {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 10px;
            height: 10px;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }
        
        #loading-overlay p {
            margin-top: 10px;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            #main-content {
                flex-direction: column-reverse; 
            }

            #app-container.lite-mode-on #main-content {
                flex-direction: column; 
            }

            #sidebar {
                width: 100%;
                height: 40%; 
                box-sizing: border-box;
                border-top: 1px solid #d1d5db;
                box-shadow: none;
            }

            header h1 {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <h1><i class="fas fa-bus"></i>City Bus Tracker</h1>
            <div class="lite-mode-toggle">
                <label for="lite-mode">Lite Mode</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="lite-mode">
                    <span class="slider"></span>
                </label>
            </div>
        </header>

        <main id="main-content">
            <div id="sidebar">
                <div id="route-selector">
                    <label for="route-select">Select a Bus Route</label>
                    <select id="route-select"></select>
                </div>

                <div id="bus-info">
                    <h3>Bus Details</h3>
                    <div id="bus-info-content">
                        <p><strong>Bus:</strong> <span id="info-bus-number"></span></p>
                        <p><strong>Speed:</strong> <span id="info-bus-speed"></span> km/h</p>
                        <p><strong>Status:</strong> <span id="info-bus-status"></span></p>
                    </div>
                </div>

                <div id="eta-list">
                    <h3>Upcoming Stops</h3>
                    <ul id="stops-container">
                        </ul>
                </div>
            </div>

            <div id="map-area">
                <div id="map"></div>
                <div id="loading-overlay">
                    <div class="spinner"></div>
                    <p>Finding buses near you...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        
        const PONDHA_UTTARAKHAND_COORDS = [30.3479, 77.9422]; 
        const DEFAULT_ZOOM = 13;
        const LITE_MODE_ZOOM = 12;
        const NORMAL_UPDATE_INTERVAL = 3000; 
        const LITE_UPDATE_INTERVAL = 10000; 
        const STOP_DWELL_TIME_SECONDS = 30; 

        const routeSelect = document.getElementById('route-select');
        const stopsContainer = document.getElementById('stops-container');
        const busInfoContent = document.getElementById('bus-info-content');
        const infoBusNumber = document.getElementById('info-bus-number');
        const infoBusSpeed = document.getElementById('info-bus-speed');
        const infoBusStatus = document.getElementById('info-bus-status');
        const liteModeToggle = document.getElementById('lite-mode');
        const loadingOverlay = document.getElementById('loading-overlay');

        let map;
        let busMarkers = {};
        let routeLayers = {};
        let selectedRouteId = null;
        let updateIntervalId = null;
        let isLiteMode = false;

        
        const mockApiData = {
            routes: [
                {
                    id: 'route1',
                    name: 'Route 101: Pondha - Clock Tower',
                    color: '#3b82f6',
                    stops: [
                        { name: 'Pondha Bus Stop', coords: [30.3479, 77.9422] },
                        { name: 'Nanda Ki Chowki', coords: [30.3395, 77.9605] },
                        { name: 'Premnagar', coords: [30.3358, 77.9811] },
                        { name: 'IMA', coords: [30.3321, 78.0045] },
                        { name: 'Ballupur Chowk', coords: [30.3340, 78.0250] },
                        { name: 'Clock Tower', coords: [30.3250, 78.0452] }
                    ]
                },
                {
                    id: 'route2',
                    name: 'Route 202: ISBT - Rajpur',
                    color: '#16a34a',
                    stops: [
                        { name: 'ISBT Dehradun', coords: [30.2917, 78.0167] },
                        { name: 'Patel Nagar', coords: [30.3125, 78.0286] },
                        { name: 'Railway Station', coords: [30.3188, 78.0390] },
                        { name: 'Dilaram Chowk', coords: [30.3292, 78.0494] },
                        { name: 'Jakhan', coords: [30.3540, 78.0645] },
                        { name: 'Rajpur Road', coords: [30.3667, 78.0700] }
                    ]
                }
            ],
            buses: [
                { id: 'bus101-1', routeId: 'route1', progress: 0.1, speed: 35 },
                { id: 'bus101-2', routeId: 'route1', progress: 0.7, speed: 40 },
                { id: 'bus202-1', routeId: 'route2', progress: 0.4, speed: 30 }
            ]
        };

        function init() {
            initMap();
            populateRouteSelector();
            setupEventListeners();
            
            selectedRouteId = mockApiData.routes[0].id;
            routeSelect.value = selectedRouteId;
            
            drawRoutes();
            startSimulation();
            
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 1500);
        }

        function initMap() {
            map = L.map('map').setView(PONDHA_UTTARAKHAND_COORDS, DEFAULT_ZOOM);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        function populateRouteSelector() {
            mockApiData.routes.forEach(route => {
                const option = document.createElement('option');
                option.value = route.id;
                option.textContent = route.name;
                routeSelect.appendChild(option);
            });
        }
        
        function setupEventListeners() {
            routeSelect.addEventListener('change', handleRouteChange);
            liteModeToggle.addEventListener('change', handleLiteModeToggle);
        }

        function handleRouteChange(e) {
            selectedRouteId = e.target.value;
            updateDisplay();
            const selectedRoute = mockApiData.routes.find(r => r.id === selectedRouteId);
            if (selectedRoute) {
                map.fitBounds(L.polyline(selectedRoute.stops.map(s => s.coords)).getBounds(), { padding: [50, 50] });
            }
        }
        
        function handleLiteModeToggle() {
            isLiteMode = liteModeToggle.checked;
            const appContainer = document.getElementById('app-container');
            console.log('Lite Mode:', isLiteMode ? 'ON' : 'OFF');

            drawRoutes(); 

            if (isLiteMode) {
                appContainer.classList.add('lite-mode-on');
            } else {
                appContainer.classList.remove('lite-mode-on');
                setTimeout(() => map.invalidateSize(), 10);
            }

            stopSimulation();
            startSimulation(); 
        }

        function startSimulation() {
            const interval = isLiteMode ? LITE_UPDATE_INTERVAL : NORMAL_UPDATE_INTERVAL;
            if (updateIntervalId) clearInterval(updateIntervalId);

            const updateFunction = isLiteMode ? updateSidebar : updateDisplay;

            updateIntervalId = setInterval(() => {
                simulateBusMovement();
                updateFunction();
            }, interval);
            updateFunction(); 
        }

        function stopSimulation() {
            if (updateIntervalId) clearInterval(updateIntervalId);
        }
        
        function simulateBusMovement() {
            mockApiData.buses.forEach(bus => {
                bus.progress += 0.01; 
                if (bus.progress > 1) {
                    bus.progress = 0; 
                }
                bus.speed = 25;
            });
        }
        
        function drawRoutes() {
            Object.values(routeLayers).forEach(layer => map.removeLayer(layer));
            routeLayers = {};

            mockApiData.routes.forEach(route => {
                const routeLine = L.polyline(route.stops.map(s => s.coords), {
                    color: route.color,
                    weight: isLiteMode ? 3 : 5,
                    opacity: 0.7
                });

                const stopMarkers = L.layerGroup(route.stops.map(stop => {
                    return L.circleMarker(stop.coords, {
                        radius: isLiteMode ? 3 : 6,
                        color: route.color,
                        fillColor: '#fff',
                        fillOpacity: 1
                    }).bindPopup(`<b>${stop.name}</b>`);
                }));
                
                routeLayers[route.id] = L.layerGroup([routeLine, stopMarkers]);
            });
        }
        
        function updateDisplay() {
            Object.keys(routeLayers).forEach(routeId => {
                if (routeId === selectedRouteId) {
                    if (!map.hasLayer(routeLayers[routeId])) {
                        map.addLayer(routeLayers[routeId]);
                    }
                } else {
                    if (map.hasLayer(routeLayers[routeId])) {
                        map.removeLayer(routeLayers[routeId]);
                    }
                }
            });
            
            updateBusMarkers();
            updateSidebar();
        }

        function updateBusMarkers() {
            const visibleBuses = mockApiData.buses.filter(b => b.routeId === selectedRouteId);
            
            Object.keys(busMarkers).forEach(busId => {
                if (!visibleBuses.some(b => b.id === busId)) {
                    map.removeLayer(busMarkers[busId]);
                    delete busMarkers[busId];
                }
            });

            visibleBuses.forEach(bus => {
                const route = mockApiData.routes.find(r => r.id === bus.routeId);
                if (!route) return;

                const busLatLng = getLatLngOnRoute(route.stops.map(s => s.coords), bus.progress);
                
                if (busMarkers[bus.id]) {
                    busMarkers[bus.id].setLatLng(busLatLng);
                } else {
                    const icon = createBusIcon();
                    busMarkers[bus.id] = L.marker(busLatLng, { icon: icon }).addTo(map);
                }
                
                busMarkers[bus.id].bindPopup(`<b>Bus ${bus.id}</b><br>Speed: ${bus.speed.toFixed(0)} km/h`);
            });
        }
        
        function createBusIcon() {
            if (isLiteMode) {
                 return L.divIcon({
                     className: 'bus-icon-lite',
                     iconSize: [14, 14]
                 });
            }
            return L.divIcon({
                html: '<i class="fa-solid fa-bus"></i>',
                className: 'bus-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        }
        
        function updateSidebar() {
            const route = mockApiData.routes.find(r => r.id === selectedRouteId);
            const busesOnRoute = mockApiData.buses.filter(b => b.routeId === selectedRouteId);

            if (!route || busesOnRoute.length === 0) {
                busInfoContent.style.display = 'none';
                stopsContainer.innerHTML = '<li>No buses currently active on this route.</li>';
                return;
            }

            const busToShow = busesOnRoute[0];
            busInfoContent.style.display = 'block';
            infoBusNumber.textContent = busToShow.id;
            infoBusSpeed.textContent = busToShow.speed.toFixed(0);
            infoBusStatus.textContent = 'On Route';

            stopsContainer.innerHTML = '';
            const totalRouteDistance = getRouteDistance(route.stops.map(s => s.coords));
            const busTravelledDistance = totalRouteDistance * busToShow.progress;
            
            let accumulatedDistance = 0;
            let upcomingStopsToPass = 0; 

            for (let i = 0; i < route.stops.length; i++) {
                const stop = route.stops[i];
                
                if (i > 0) {
                    accumulatedDistance += L.latLng(route.stops[i-1].coords).distanceTo(L.latLng(route.stops[i].coords));
                }

                const li = document.createElement('li');
                let etaHtml;

                if (accumulatedDistance < busTravelledDistance) {
                    etaHtml = `<span class="eta arrived">Arrived</span>`;
                } else {
                    const distanceToStop = accumulatedDistance - busTravelledDistance;
                    
                    const speedInMetersPerSecond = (busToShow.speed * 1000) / 3600;
                    const travelTimeInSeconds = distanceToStop / speedInMetersPerSecond;

                    const dwellTimeInSeconds = upcomingStopsToPass * STOP_DWELL_TIME_SECONDS;

                    const totalEtaInSeconds = travelTimeInSeconds + dwellTimeInSeconds;
                    const timeInMinutes = Math.ceil(totalEtaInSeconds / 60);

                    etaHtml = `<span class="eta">${timeInMinutes} min</span>`;
                    
                    upcomingStopsToPass++;
                }

                li.innerHTML = `
                    <div class="stop-icon"><i class="fas fa-map-marker-alt"></i></div>
                    <div class="stop-details">
                        <div class="stop-name">${stop.name}</div>
                    </div>
                    ${etaHtml}
                `;
                stopsContainer.appendChild(li);
            }
        }
        

        function getLatLngOnRoute(coords, progress) {
            const totalDist = getRouteDistance(coords);
            const targetDist = totalDist * progress;

            let travelledDist = 0;
            for (let i = 0; i < coords.length - 1; i++) {
                const start = L.latLng(coords[i]);
                const end = L.latLng(coords[i+1]);
                const segmentDist = start.distanceTo(end);

                if (travelledDist + segmentDist >= targetDist) {
                    const remainingDist = targetDist - travelledDist;
                    const ratio = remainingDist / segmentDist;
                    return L.latLng(
                        start.lat + (end.lat - start.lat) * ratio,
                        start.lng + (end.lng - start.lng) * ratio
                    );
                }
                travelledDist += segmentDist;
            }
            return coords[coords.length - 1]; 
        }

        function getRouteDistance(coords) {
            let totalDist = 0;
            for (let i = 0; i < coords.length - 1; i++) {
                totalDist += L.latLng(coords[i]).distanceTo(L.latLng(coords[i+1]));
            }
            return totalDist;
        }

        
        init();
    });
    </script>
</body>
</html>